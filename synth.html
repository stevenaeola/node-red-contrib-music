<script type="text/javascript">
 
 var synthtypes = {
     ambi_choir: {},
     ambi_dark_woosh: {},
     ambi_drone: {tuned: true, midibase: 60},
     ambi_glass_hum: {tuned: true, midibase: 57},
     ambi_glass_rub: {tuned: true, midibase: 66},
     ambi_haunted_hum: {tuned: true, midibase: 63.25},
     ambi_lunar_land: {},
     ambi_piano: {tuned: true, midibase: 58},
     ambi_sauna: {},
     ambi_soft_buzz: {tuned: true, midibase: 54.45},
     ambi_swoosh: {},

     arpy: {tuned: true},

     bass_dnb_f: {tuned: true, midibase: 53},
     bass_drop_c: {tuned: true, midibase: 48},
     bass_hard_c: {tuned: true, midibase: 48},
     bass_hit_c: {tuned: true, midibase: 51},
     bass_thick_c: {tuned: true, midibase: 48},
     bass_trance_c: {tuned: true, midibase: 48},
     bass_voxy_c: {tuned: true, midibase: 48},
     bass_voxy_hit_c: {tuned: true, midibase: 48},
     bass_woodsy_c: {tuned: true, midibase: 48},

     bd_808: {},
     bd_ada: {},
     bd_boom: {},
     bd_fat: {},
     bd_gas: {},
     bd_haus: {},
     bd_klub: {},
     bd_mehackit: {},
     bd_pure: {},
     bd_sone: {},
     bd_tek: {},
     bd_zome: {},
     bd_zum: {},

     bass0: {},
     bass2: {tuned: true, midibase: 64},
     bass3: {tuned: true, midibase: 57},
     bass: {tuned: true, midibase: 55},
     bd: {},
     bell: {tuned: true, synth:true},
     birds3: {},
     blip: {tuned: true},
     bottle: {},
     can: {},

     cr: {},
     crotale: {synth:true},
     crow: {},
     diphone2: {},
     drum: {},

     drum_bass_hard: {},
     drum_bass_soft: {},
     drum_cowbell: {},
     drum_cymbal_closed: {},
     drum_cymbal_hard: {},
     drum_cymbal_open: {},
     drum_cymbal_pedal: {},
     drum_cymbal_soft: {},
     drum_heavy_kick: {},
     drum_roll: {},
     drum_snare_hard: {},
     drum_snare_soft: {},
     drum_splash_hard: {},
     drum_splash_soft: {},
     drum_tom_hi_hard: {},
     drum_tom_hi_soft: {},
     drum_tom_lo_hard: {},
     drum_tom_lo_soft: {},
     drum_tom_mid_hard: {},
     drum_tom_mid_soft: {},

     drumtraks: {},
     dulcimer: {tuned: true, synth:true},
     dx: {tuned: true, synth:true},

     elec_beep: {},
     elec_bell: {tuned: true, midibase: 53},
     elec_blip: {tuned: true, midibase: 62},
     elec_blip2: {tuned: true, midibase: 62},
     elec_blup: {},
     elec_bong: {},
     elec_chime: {},
     elec_cymbal: {},
     elec_filt_snare: {},
     elec_flip: {tuned: true, midibase: 60},
     elec_fuzz_tom: {},
     elec_hi_snare: {},
     elec_hollow_kick: {},
     elec_lo_snare: {},
     elec_mid_snare: {},
     elec_ping: {tuned: true, midibase: 69},
     elec_plip: {},
     elec_pop: {tuned: true, midibase: 60},
     elec_snare: {},
     elec_soft_kick: {tuned: true, midibase: 41},
     elec_tick: {tuned: true, midibase: 60},
     elec_triangle: {},
     elec_twang: {},
     elec_twip: {},
     elec_wood: {},


     feel: {},
     flick: {tuned: true},
     fmtanh: {tuned: true, synth:true},
     future: {},
     gabba: {},
     ghost: {tuned: true, synth:true},

     glitch_bass_g: {tuned: true, midibase: 55},
     glitch_perc1: {},
     glitch_perc2: {},
     glitch_perc3: {},
     glitch_perc4: {},
     glitch_perc5: {},
     glitch_robot1: {},
     glitch_robot2: {},


     gretsch: {},

     guit_e_fifths: {tuned: true, midibase: 52},
     guit_e_slide: {tuned: true, midibase: 64},
     guit_em9: {tuned: true, midibase: 52},
     guit_harmonics: {tuned: true, midibase: 64},
     
     h: {},
     hc: {},
     hh: {},
     ho: {},
     house: {},
     industrial: {},
     jazz: {},
     jvbass: {tuned: true, midibase: 54},
     kick: {synth:true},
     kurt: {tuned: true, midibase: 64},
     latibro: {},
     less: {},
     lighter: {},
     lt: {tuned: true},
     marimba: {tuned: true, synth:true},

     mehackit_phone1: {},
     mehackit_phone2: {},
     mehackit_phone3: {},
     mehackit_phone4: {},
     mehackit_robot1: {},
     mehackit_robot2: {},
     mehackit_robot3: {},
     mehackit_robot4: {},
     mehackit_robot5: {},
     mehackit_robot6: {},
     mehackit_robot7: {},

     metal: {},

     misc_burp: {},
     misc_cineboom: {},
     misc_clap: {},
     misc_crow: {},

     moog: {tuned: true, synth:true},
     mouth: {},
     mt: {},
     newnotes: {tuned: true, midibase: 61},
     odx: {},
     off: {tuned: true, midibase: 61},
     perc: {},

     perc_bell: {},
     perc_bell2: {},
     perc_door: {},
     perc_impact1: {},
     perc_impact2: {},
     perc_snap: {},
     perc_snap2: {},
     perc_swash: {},
     perc_swoosh: {},
     perc_till: {},

     piano: {tuned: true, synth:true},
     pluck: {tuned: true, midibase: 58},
     print: {},
     prophet: {tuned: true, synth:true},
     psr: {tuned: true, midibase: 53},
     rm: {},
     "short": {},
     sid: {},
     sn: {},

     sn_dolf: {},
     sn_dub: {},
     sn_generic: {},
     sn_zome: {},


     snare: {synth:true},
     stab: {},
     tabla: {},

     tabla_dhec: {},
     tabla_ghe1: {},
     tabla_ghe2: {},
     tabla_ghe3: {},
     tabla_ghe4: {},
     tabla_ghe5: {},
     tabla_ghe6: {},
     tabla_ghe7: {},
     tabla_ghe8: {},
     tabla_ke1: {},
     tabla_ke2: {},
     tabla_ke3: {},
     tabla_na: {},
     tabla_na_o: {},
     tabla_na_s: {},
     tabla_re: {},
     tabla_tas1: {},
     tabla_tas2: {},
     tabla_tas3: {},
     tabla_te1: {},
     tabla_te2: {},
     tabla_te_m: {},
     tabla_te_ne: {},
     tabla_tun1: {},
     tabla_tun2: {},
     tabla_tun3: {},
     
     tink: {},
     trump: {tuned: true, midibase: 59},
     ul: {tuned: true},

     vinyl_backspin: {},
     vinyl_hiss: {},
     vinyl_rewind: {},
     vinyl_scratch: {},

     voodoo: {}
 };

 var fxtypes = {
     reverb: {inBus: 4},
     delay: {inBus: 6},
     LPF: {inBus: 8},
     HPF: {inBus: 10},
     drop: {inBus: 12},

 }
 

 RED.nodes.registerType('synth',{
     category: 'music',
     color: '#a6bbcf',
     defaults: {
	 name: {value: "", required: false},
	 synthtype: {value: "kick", required: true},
	 tuned: {value: "all", required: false},
	 volume: {value: 50},
	 octave: {value: 0},
	 root: {value:"", required: false},
	 scale: {value:"", required: false},
	 degree: {value:"", required: false},
	 outBus: {value:0, required: true},
	 synthtypes: {value:synthtypes, required: false}
     },
     
     inputs:1,
     inputLabels:"tick or synthcontrol",
     outputs:1,
     outputLabels:["supercollider instructions"],
     icon: "file.png",
     label: function() {
	 return this.name || this.synthtype || "synth";
     },
     
     oneditprepare: function(){
	 node = this;

	 function populate(which){
	     $("#node-input-synthtype").empty();

	     for(var synthtype in synthtypes){
		 var row = $("<option value='" + synthtype + "'>" + synthtype + "</option>");
		 if(node.synthtype == synthtype){
		     row.attr("selected", "selected");
		 }
		 var select = $("#node-input-synthtype");
		 var tuned = synthtypes[synthtype].tuned;
		 switch(which){
		     case "all":
			 select.append(row);
			 break;

		     case "tuned":
			 if(tuned){
			     select.append(row);
			 }
			 break;

		     case "untuned":
			 if(!tuned){
			     select.append(row);
			 }
			 break;

		 }
	     }
	 }

	 function filterSynthtypes(which){
	     if(!which){
		 which = "all";
	     }
	     node.tuned = which;
	     $('#node-input-synthtype-selector-container span').addClass("muted");
	     $('#node-input-synthtype-selector-' + which).removeClass("muted");
	     populate(which);
	 };
	 
	 filterSynthtypes(node.tuned);
	 
	 var tunedContainer = $('#node-input-tuned-container');

	 $('#node-input-synthtype').change(
	     function (){
		 var option = $(this).find('option:selected').val();
		 if(synthtypes[option] && synthtypes[option].tuned){
		     tunedContainer.show();
		 }
		 else{
		     tunedContainer.hide();
		 }
	     }
	 );
	 
	 $('#node-input-synthtype-selector-all').click(
	     () =>  {
		 filterSynthtypes('all');
	     }
	 );
	 
     	 $('#node-input-synthtype-selector-tuned').click(
	     () => {
		 filterSynthtypes('tuned');
		 tunedContainer.show();
	     }
	 );
	 
	 $('#node-input-synthtype-selector-untuned').click(
	     () => {
		 filterSynthtypes('untuned');
		 tunedContainer.hide();
	     }
	 );

     }
 });
</script>

<script type="text/x-red" data-template-name="synth">
    <div class="form-row">
	<label for="node-input-synthtype"> Synth type</label>
	<select id="node-input-synthtype">
	</select>
	<div id="node-input-synthtype-selector-container" style="float:right">
	    <small>
		<span id="node-input-synthtype-selector-all">all</span> |
		<span id="node-input-synthtype-selector-untuned" class="muted">untuned</span> |
		<span id="node-input-synthtype-selector-tuned" class="muted">tuned</span> 
	    </small>
	</div>
    </div>

    <div class="form-row">
	<label for="node-input-volume"> Volume</label>
	<input type="number" min="0" max="100" id="node-input-volume" placeholder="0-100" style="width:7em">
    </div>
    <!-- 
	 <div class="form-row">
	 <label for="node-input-outBus"> output bus </label>
	 <input type="number" id="node-input-outBus" placeholder="0 for direct output">
	 </div>
       -->
    <div id='node-input-tuned-container' style="display:none">

	<div class="form-row">
	    <label for="node-input-octave"> Octave</label>
	    <input type="number" min="-4" max="4" id="node-input-octave" placeholder="e.g. -1" style="width:7em">
	</div>

	<div id="node-input-key-container">
	    <div class="form-row">
		<label for="node-input-root"> Scale</label>
		<input type="text" id="node-input-root" placeholder="e.g. C4" style="width:7em">
		<select id="node-input-scale">
		    <option></option>
		    <option>minor</option>
		    <option>major</option>
		    <option>dorian</option>
		    <option>mixolydian</option>
		    <option>major pentatonic</option>
		    <option>minor pentatonic</option>
		    <option>blues</option>
		    <option>chromatic</option>
		</select
	    </div>

	    <div class="form-row">
		<label for="node-input-degree"> Degree</label>
		<select id="node-input-degree">
		    <option></option>
		    <option>I</option>
		    <option>II</option>
		    <option>III</option>
		    <option>IV</option>
		    <option>V</option>
		    <option>VI</option>
		    <option>VII</option>
		</select>
	    </div>

	</div>
	
    </div>

    <div class="form-row">
	<label for="node-input-name"><i class="icon-tag"></i> Name</label>
	<input type="text" id="node-input-name" placeholder="">
    </div>



</script>

<script type="text/x-red" data-help-name="synth">
  <p>Turns note instructions into SuperCollider messages for controlling synthesisers.</p>
  
    <h3>Inputs</h3>

    <p>A synth usually gets its input from a <code>sequencer</code> node or a <code>beat</code> node, possibly via <code>divider</code>, <code>link</code> and <code>switch</code> nodes.</p>
  <dl class='message-properties'>

    <dt class="optional">topic <span class="property-type">string</span></dt>
    <dd><p>If <code>msg.topic</code> is <code>volume</code> then <code>msg.payload</code> is used to set the volume of the sounds produced, in the range 0 to 100.</p>
    <p>If <code>msg.topic</code> starts with <code>synthcontrol:</code> then the rest of the <code>msg.topic</code> is interpreted as a SuperCollider synth parameter name, and the <code>msg.payload</code> is used as its value. The parameters that can be changed vary from synth to synth, and not all synths have paremeters.</p></dd>

    <dt class="optional">note <span class="property-type">number|array</span></dt>
    <dd>If <code>msg.note</code> is defined then it is used to set the <code>midi</code> note value of the output. If <code>msg.note</code> is an array then all the notes in the array are played at the same time to form a chord.</dd>

    <dt>payload <span class='property-type'>string|number</span></dt>
    <dd>When <code>msg.topic</code> is empty<ul>
	<li>If <code>msg.payload</code> is <code>play</code> or <code>tick</code> then instructions are output for playing a note.</li>
	<li>If <code>msg.payload</code> is <code>reset</code> then the synth goes back to its starting state.</li>
	<li>If <code>msg.payload</code> is <code>stop</code> then the synth is stopped. This only makes a difference is the synth has sustain</li>
    </ul></dd>

    <dt><span class='optional'>timeTag</span> <span class='property-type'>number</span></dt>
    <dd>If a <code>timeTag</code> property is given for the incoming <code>play</code> message it is included in the outgoing message.</dd>


  </dl>

  <h3>Outputs</h3>

  <p>A synth usually sends its output to a <code>osc</code> node, which prepares the synthesiser instructions for sending via a <code>udp</code> node to a SuperCollider server.</p>

  <p>The <code>msg.topic</code> and <code>msg.payload</code> are ready to be encoded via <code>osc</code> according to the <a target="_new" href='http://danielnouri.org/docs/SuperColliderHelp/ServerArchitecture/Server-Command-Reference.html'>SuperCollider server commands</a>.</p>
  
  <h3>Configuration</h3>

  <dl class='message-properties'>

    <dt><span class='optional'>name</span> <span class='property-type'>string</span></dt>
    <dd>The name of the synthesiser type to use. Some types of synthesiser have sustain, which means that the note continues playing until the synthiseser receives a <code>stop</code> or <code>reset</code> value in <code>msg.payload</code> or a <code>null</code> value for <code>msg.note</code></dd>

    <dt>start volume <span class='property-type'>number</span></dt>
    <dd>A value in the range 0 to 100 to specify the volume that the synth uses after deployment or reset.</dd>

    <dt>octave <span class='property-type'>number</span></dt>
    <dd>A number, usually in the range -3 to +3, to shift the pitch relative to the root note, with negative numbers used to lower the pitch.</dd>
    
    <dt>root note of scale <span class='property-type'>string</span></dt>
    <dd>If defined, this gives the name and octave of the start of the scale, which corresponds to a <code>msg.note</code> of 1. If not defined, the global or default value is used.</dd>

    <dt>scale type <span class='property-type'>string</span></dt>
    <dd>The midi pitch value that is output depends on the value of <code>msg.note</code> and the scale root and the scale type. If not defined, the global or default value is used.</dd>

    <dt>output bus <span class='property-type'>number</span></dt>
    <dd>Can be used to select an effect bus to send the synthesiser output to instead of the default bus 0.</dd>

  </dl>
  
  <h3>Details</h3>
  
  <p>The synth node relies on there being a SuperCollider server running, to which the messages are sent via <code>osc</code> and (usually) <code>udp</code>. Synthdefs are sent to the SuperCollider server when the nodes are deployed.</p>


  <p>Separate sound effects (soundfx) nodes can be defined which include a bus number to receive input from a synth. These will only work on local machines.</p>
  
</script>

<script type="text/javascript">
 RED.nodes.registerType('soundfx',{
     category: 'music',
     color: '#a6bbcf',
     defaults: {
	 fxtype: {value: "reverb", required: "true"},
	 fxtypes: {value: fxtypes, required: "false"}
        },
     inputs:1,
     inputLabels:"supercollider instructions or fxcontrol",
     outputs:1,
     outputLabels:["supercollider instructions"],
  icon: "file.png",
  label: function() {
  return this.name || this.fxtype || "soundfx";
  }
  });
</script>

<script type="text/x-red" data-template-name="soundfx">
 <div class="form-row">
 <label for="node-input-fxtype">Effect Type</label>
 <select id="node-input-fxtype">
 <option>reverb</option>
 <option>delay</option>
 <option>LPF</option>
 <option>HPF</option>
 <option>drop</option>
 </select>
 </div>
</script>

<script type="text/x-red" data-help-name="soundfx">
    <p>Make a SuperCollider sound effect</p>
</script>
